---
import Image from '../atoms/Image.astro';
import Button from '../atoms/Button.astro';
import Icon from '../atoms/Icon.astro';
import Spinner from '../atoms/Spinner.astro';
---

<div
  id="cart-popup"
  class="fixed inset-0 z-[100] hidden"
  aria-hidden="true"
  style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;"
>
  <!-- Backdrop -->
  <div
    id="cart-popup-backdrop"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300"
  ></div>

  <!-- Popup -->
  <div
    id="cart-popup-content"
    class="fixed right-0 top-0 h-full w-full max-w-md bg-white dark:bg-gray-900 shadow-2xl transform transition-transform duration-300 ease-out overflow-hidden flex flex-col translate-x-full"
  >
    <!-- Header -->
    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 sticky top-0 z-10">
      <div class="flex items-center gap-2">
        <h2 class="font-outfit font-bold text-lg text-gray-900 dark:text-white">
          Cart
        </h2>
        <span 
          id="cart-popup-count" 
          class="inline-flex items-center justify-center min-w-[20px] h-5 px-1.5 rounded-full bg-primary/10 dark:bg-primary/20 text-primary font-semibold text-xs"
        >
          0
        </span>
      </div>
      <button
        id="cart-popup-close"
        class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 transition-all duration-200"
        aria-label="Close cart"
      >
        <Icon name="close" size="sm" />
      </button>
    </div>

    <!-- Cart Items -->
    <div
      id="cart-popup-items"
      class="flex-1 overflow-y-auto overscroll-contain px-4 py-3"
    >
      <!-- Empty state -->
      <div id="cart-popup-empty" class="flex flex-col items-center justify-center py-12">
        <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mb-3">
          <svg class="w-8 h-8 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
        </div>
        <p class="font-outfit font-medium text-base text-gray-900 dark:text-white mb-1">
          Your cart is empty
        </p>
        <p class="font-outfit text-sm text-gray-500 dark:text-gray-400 text-center max-w-xs">
          Add products to start shopping
        </p>
      </div>
    </div>

    <!-- Footer -->
    <div
      id="cart-popup-footer"
      class="border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 hidden"
    >
      <!-- Totals -->
      <div class="px-4 pt-3 pb-2">
        <div class="flex justify-between items-center font-outfit text-sm text-gray-600 dark:text-gray-400 mb-2">
          <span>Subtotal</span>
          <span id="cart-popup-subtotal" class="font-medium">0 €</span>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 pt-2">
          <div class="flex justify-between items-center font-outfit font-bold text-base text-gray-900 dark:text-white">
            <span>Total</span>
            <span id="cart-popup-total" class="text-primary">0 €</span>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="px-4 pb-3 pt-2 flex flex-col gap-2">
        <Button
          href="/checkout"
          variant="primary"
          size="lg"
          class="w-full font-semibold text-center"
        >
          Checkout
        </Button>
        <Button
          href="/panier"
          variant="outline"
          size="lg"
          class="w-full font-medium text-center"
        >
          View Cart
        </Button>
      </div>
    </div>
  </div>
</div>

<script>
  let cartPopup: HTMLElement | null = null;
  let cartPopupBackdrop: HTMLElement | null = null;
  let cartPopupContent: HTMLElement | null = null;
  let cartPopupClose: HTMLElement | null = null;
  let cartPopupItems: HTMLElement | null = null;
  let cartPopupFooter: HTMLElement | null = null;

  function openCartPopup() {
    if (cartPopup && cartPopupContent && cartPopupBackdrop) {
      cartPopup.classList.remove('hidden');
      // Force reflow to ensure animation
      requestAnimationFrame(() => {
        cartPopupBackdrop.style.opacity = '0';
        cartPopupContent.classList.remove('translate-x-full');
        requestAnimationFrame(() => {
          cartPopupBackdrop.style.opacity = '1';
        });
      });
      document.body.style.overflow = 'hidden';
      // Always load cart data when opening (with small delay to ensure DOM is ready)
      setTimeout(() => {
        loadCartPopup();
      }, 50);
    }
  }

  function closeCartPopup() {
    if (cartPopup && cartPopupContent && cartPopupBackdrop) {
      cartPopupContent.classList.add('translate-x-full');
      cartPopupBackdrop.style.opacity = '0';
      setTimeout(() => {
        if (cartPopup) {
          cartPopup.classList.add('hidden');
        }
        document.body.style.overflow = '';
      }, 300);
    }
  }

  function updateCartPopupWithData(cart: any) {
    const items = cart.items || [];
    const totals = cart.totals || {};
    renderCartItems(items, totals, cart.items_count || items.length);
  }

  function formatPrice(price: string | number): string {
    if (!price && price !== 0) return '0';
    const priceStr = String(price);
    // Remove currency symbols and spaces, keep numbers and decimal point
    const cleaned = priceStr.replace(/[€\s,]/g, '').trim();
    // Convert to number and back to string to handle decimals properly
    const num = parseFloat(cleaned);
    if (isNaN(num)) return '0';
    // Format without decimals if it's a whole number
    return num % 1 === 0 ? num.toString() : num.toFixed(2);
  }

  function renderCartItems(items: any[], totals: any, itemsCount: number) {
    console.log('renderCartItems called with:', { items, totals, itemsCount });
    
    // Ensure DOM elements are available
    if (!cartPopupItems) {
      cartPopupItems = document.getElementById('cart-popup-items');
    }
    if (!cartPopupFooter) {
      cartPopupFooter = document.getElementById('cart-popup-footer');
    }
    
    if (!cartPopupItems) {
      console.error('cartPopupItems not found in renderCartItems');
      return;
    }

    // Update count
    const countElement = document.getElementById('cart-popup-count');
    if (countElement) {
      countElement.textContent = String(itemsCount || items.length || 0);
    }

    // Handle empty cart
    if (items.length === 0) {
      cartPopupItems.innerHTML = `
        <div id="cart-popup-empty" class="flex flex-col items-center justify-center py-12">
          <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mb-3">
            <svg class="w-8 h-8 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
          </div>
          <p class="font-outfit font-medium text-base text-gray-900 dark:text-white mb-1">
            Your cart is empty
          </p>
          <p class="font-outfit text-sm text-gray-500 dark:text-gray-400 text-center max-w-xs">
            Add products to start shopping
          </p>
        </div>
      `;
      if (cartPopupFooter) {
        cartPopupFooter.classList.add('hidden');
      }
      return;
    }

    cartPopupItems.innerHTML = items
        .map(
          (item: any, index: number) => {
            const quantity = item.quantity || 1;
            // Get unit price
            const unitPriceRaw = item.prices?.price || item.price || item.prices?.unit_price || '0';
            const unitPrice = formatPrice(unitPriceRaw);
            
            // Calculate total price: use prices.total if available, otherwise calculate unitPrice * quantity
            let totalPriceRaw = item.prices?.total || item.total || item.prices?.line_total || '0';
            // If total is 0 or invalid, calculate it
            if (!totalPriceRaw || totalPriceRaw === '0' || parseFloat(String(totalPriceRaw).replace(/[€\s,]/g, '')) === 0) {
              const unitPriceNum = parseFloat(unitPrice) || 0;
              totalPriceRaw = (unitPriceNum * quantity).toString();
            }
            const totalPrice = formatPrice(totalPriceRaw);
            const itemKey = item.key || item.id;
            const productId = item.id || item.product_id || '';
            const imageUrl = item.images?.[0]?.src || item.image?.src || '/placeholder-product.jpg';
            const imageAlt = item.images?.[0]?.alt || item.name || 'Product';
            const productName = item.name || 'Product';

            return `
            <div class="group relative bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-3 transition-all duration-200 hover:shadow-sm hover:border-gray-300 dark:hover:border-gray-600 ${index > 0 ? 'mt-2' : ''}" data-item-key="${itemKey}">
              <div class="flex gap-3">
                <!-- Product Image -->
                <a href="/produit/${productId}" class="flex-shrink-0 relative">
                  <img
                    src="${imageUrl}"
                    alt="${imageAlt}"
                    class="w-16 h-16 object-cover rounded-md transition-transform duration-200 group-hover:scale-105"
                    loading="lazy"
                  />
                </a>
                
                <!-- Product Info -->
                <div class="flex-1 min-w-0 flex flex-col justify-between">
                  <div>
                    <a 
                      href="/produit/${productId}" 
                      class="font-outfit font-semibold text-sm text-gray-900 dark:text-white hover:text-primary transition-colors block mb-1 line-clamp-2"
                    >
                      ${productName}
                    </a>
                    
                    <p class="font-outfit text-xs text-gray-500 dark:text-gray-400 mb-2">
                      ${unitPrice} € / unit
                    </p>
                  </div>
                  
                  <!-- Quantity Controls & Price -->
                  <div class="flex items-center justify-between gap-3">
                    <!-- Quantity Controls -->
                    <div class="flex items-center gap-1 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-900/50">
                      <button
                        class="w-7 h-7 flex items-center justify-center rounded hover:bg-white dark:hover:bg-gray-800 transition-colors disabled:opacity-40 disabled:cursor-not-allowed quantity-btn-decrease"
                        data-action="decrease"
                        data-key="${itemKey}"
                        aria-label="Decrease quantity"
                        ${quantity <= 1 ? 'disabled' : ''}
                      >
                        <svg class="w-3.5 h-3.5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                        </svg>
                      </button>
                      
                      <span class="font-outfit font-medium w-6 text-center text-sm quantity-display">${quantity}</span>
                      
                      <button
                        class="w-7 h-7 flex items-center justify-center rounded hover:bg-white dark:hover:bg-gray-800 transition-colors quantity-btn-increase"
                        data-action="increase"
                        data-key="${itemKey}"
                        aria-label="Increase quantity"
                      >
                        <svg class="w-3.5 h-3.5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                      </button>
                    </div>
                    
                    <!-- Price & Remove -->
                    <div class="flex items-center gap-3">
                      <p class="font-outfit font-bold text-sm text-gray-900 dark:text-white whitespace-nowrap">
                        ${totalPrice} €
                      </p>
                      <button
                        class="w-7 h-7 flex items-center justify-center rounded text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors remove-btn"
                        data-action="remove"
                        data-key="${itemKey}"
                        aria-label="Remove"
                        title="Remove"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          }
        )
        .join('');

      // Add event listeners for quantity and remove buttons
      cartPopupItems
        .querySelectorAll('[data-action]')
        .forEach((button) => {
          button.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const action = button.getAttribute('data-action');
            const itemKey = button.getAttribute('data-key');
            if (!itemKey) return;

            const itemElement = cartPopupItems?.querySelector(`[data-item-key="${itemKey}"]`);
            if (!itemElement) return;

            // Disable buttons during request
            const allButtons = itemElement.querySelectorAll('[data-action]');
            allButtons.forEach(btn => {
              (btn as HTMLButtonElement).disabled = true;
            });

            try {
              if (action === 'remove') {
                const response = await fetch('/api/cart/remove-item', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  credentials: 'include',
                  body: JSON.stringify({ key: itemKey }),
                });

                if (response.ok) {
                  window.dispatchEvent(new Event('cartUpdated'));
                  loadCartPopup();
                }
              } else if (action === 'increase' || action === 'decrease') {
                const quantityDisplay = itemElement.querySelector('.quantity-display');
                const currentQuantity = parseInt(quantityDisplay?.textContent || '1');
                const newQuantity = action === 'increase' 
                  ? currentQuantity + 1 
                  : Math.max(1, currentQuantity - 1);

                const response = await fetch('/api/cart/update-item', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  credentials: 'include',
                  body: JSON.stringify({ key: itemKey, quantity: newQuantity }),
                });

                if (response.ok) {
                  const result = await response.json();
                  const updatedItem = result.items?.find((i: any) => i.key === itemKey);
                  if (updatedItem && quantityDisplay) {
                    quantityDisplay.textContent = String(updatedItem.quantity);
                    
                    // Update price
                    const priceElement = itemElement.querySelector('.font-bold');
                    if (priceElement) {
                      const newTotal = formatPrice(updatedItem.prices?.total || updatedItem.total || '0');
                      priceElement.textContent = `${newTotal} €`;
                    }
                    
                    // Update decrease button state
                    const decreaseBtn = itemElement.querySelector('.quantity-btn-decrease') as HTMLButtonElement;
                    if (decreaseBtn) {
                      decreaseBtn.disabled = updatedItem.quantity <= 1;
                    }
                    
                    // Update totals
                    window.dispatchEvent(new Event('cartUpdated'));
                    setTimeout(() => loadCartPopup(), 300);
                  }
                }
              }
            } catch (error) {
              console.error('Error updating cart:', error);
              if (window.showToast) {
                window.showToast('An error occurred. Please try again.', 'error', 5000);
              }
            } finally {
              // Re-enable buttons
              allButtons.forEach(btn => {
                (btn as HTMLButtonElement).disabled = false;
              });
            }
          });
        });

    // Show footer
    if (cartPopupFooter) {
      cartPopupFooter.classList.remove('hidden');
    }

    // Update totals
    const subtotalElement = document.getElementById('cart-popup-subtotal');
    const totalElement = document.getElementById('cart-popup-total');
    const totalPrice = formatPrice(totals.total_price || '0');
    
    if (subtotalElement) {
      subtotalElement.textContent = `${totalPrice} €`;
    }
    if (totalElement) {
      totalElement.textContent = `${totalPrice} €`;
    }
  }

  async function loadCartPopup() {
    // Ensure DOM elements are available
    if (!cartPopupItems) {
      cartPopupItems = document.getElementById('cart-popup-items');
    }
    
    if (!cartPopupItems) {
      console.error('cartPopupItems not found');
      return;
    }

    try {
      // Show loading state
      cartPopupItems.innerHTML = `
        <div class="flex items-center justify-center py-8">
          <svg
            class="w-6 h-6 animate-spin text-primary"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </div>
      `;

      // Log cookies before request
      console.log('Cookies before fetch:', document.cookie);
      
      const response = await fetch('/api/cart', {
        credentials: 'include',
        headers: {
          'Accept': 'application/json',
        },
      });

      // Log Set-Cookie headers from response
      const setCookieHeaders = response.headers.get('set-cookie');
      console.log('Set-Cookie headers:', setCookieHeaders);

      if (!response.ok) {
        throw new Error(`Failed to load cart: ${response.status}`);
      }

      const cart = await response.json();
      console.log('Cart loaded:', cart);
      console.log('Cookies after fetch:', document.cookie);
      
      const items = cart.items || [];
      const totals = cart.totals || {};
      const itemsCount = cart.items_count || items.length;

      console.log('Items:', items);
      console.log('Items count:', itemsCount);
      console.log('Totals:', totals);

      if (!cartPopupItems) {
        console.error('cartPopupItems is null before renderCartItems');
        return;
      }

      renderCartItems(items, totals, itemsCount);
      console.log('renderCartItems completed');
    } catch (error) {
      console.error('Error loading cart:', error);
      if (cartPopupItems) {
        cartPopupItems.innerHTML = `
          <div class="text-center py-8">
            <p class="font-outfit text-sm text-red-600 dark:text-red-400 mb-3">
              Error loading cart
            </p>
            <button 
              id="retry-cart-load"
              class="font-outfit text-sm text-primary hover:underline px-4 py-2 rounded-lg hover:bg-primary/10 transition-colors"
            >
              Retry
            </button>
          </div>
        `;
        // Add event listener to retry button
        const retryButton = document.getElementById('retry-cart-load');
        if (retryButton) {
          retryButton.addEventListener('click', loadCartPopup);
        }
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    cartPopup = document.getElementById('cart-popup');
    cartPopupBackdrop = document.getElementById('cart-popup-backdrop');
    cartPopupContent = document.getElementById('cart-popup-content');
    cartPopupClose = document.getElementById('cart-popup-close');
    cartPopupItems = document.getElementById('cart-popup-items');
    cartPopupFooter = document.getElementById('cart-popup-footer');

    // Close handlers
    if (cartPopupClose) {
      cartPopupClose.addEventListener('click', closeCartPopup);
    }

    if (cartPopupBackdrop) {
      cartPopupBackdrop.addEventListener('click', closeCartPopup);
    }

    // ESC key handler
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && cartPopup && !cartPopup.classList.contains('hidden')) {
        closeCartPopup();
      }
    });

    // Expose functions globally
    (window as any).openCartPopup = openCartPopup;
    (window as any).updateCartPopupWithData = updateCartPopupWithData;
    (window as any).loadCartPopup = loadCartPopup;

    // Load cart on open event (from CartButton)
    // Note: openCartPopup() already calls loadCartPopup(), so we don't need to do it again here
    // This event is kept for compatibility but won't trigger a double load
    window.addEventListener('cartPopupOpen', () => {
      // openCartPopup() already handles loading, so we just ensure it's called
      if (cartPopup && !cartPopup.classList.contains('hidden')) {
        // Popup is already open, just refresh the data
        loadCartPopup();
      }
    });

    // Update cart when it changes
    window.addEventListener('cartUpdated', () => {
      if (cartPopup && !cartPopup.classList.contains('hidden')) {
        loadCartPopup();
      }
    });
  });
</script>

<style>
  /* Smooth scrollbar */
  #cart-popup-items {
    scrollbar-width: thin;
    scrollbar-color: rgb(203 213 225) transparent;
  }
  
  #cart-popup-items::-webkit-scrollbar {
    width: 6px;
  }
  
  #cart-popup-items::-webkit-scrollbar-track {
    background: transparent;
  }
  
  #cart-popup-items::-webkit-scrollbar-thumb {
    background-color: rgb(203 213 225);
    border-radius: 3px;
  }
  
  #cart-popup-items::-webkit-scrollbar-thumb:hover {
    background-color: rgb(148 163 184);
  }
  
  .dark #cart-popup-items::-webkit-scrollbar-thumb {
    background-color: rgb(55 65 81);
  }
  
  .dark #cart-popup-items::-webkit-scrollbar-thumb:hover {
    background-color: rgb(75 85 99);
  }
  
  /* Cart item animations */
  [data-item-key] {
    animation: slideIn 0.3s ease-out;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Quantity button hover effects */
  .quantity-btn-decrease:hover:not(:disabled),
  .quantity-btn-increase:hover:not(:disabled) {
    transform: scale(1.1);
  }
  
  .quantity-btn-decrease:active:not(:disabled),
  .quantity-btn-increase:active:not(:disabled) {
    transform: scale(0.95);
  }
  
  /* Remove button hover effect */
  .remove-btn {
    position: relative;
  }
  
  .remove-btn::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 1px;
    background-color: currentColor;
    transition: width 0.2s ease;
  }
  
  .remove-btn:hover::after {
    width: 100%;
  }
  
  /* Responsive adjustments */
  @media (max-width: 640px) {
    #cart-popup-content {
      max-width: 100%;
    }
  }
  
  /* Loading state */
  .quantity-btn-decrease:disabled,
  .quantity-btn-increase:disabled {
    cursor: wait;
  }
</style>

